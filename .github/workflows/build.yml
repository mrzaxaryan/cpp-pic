name: Build and Test

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - "**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  LLVM_VERSION: "20.1.6"

jobs:
  build-and-test-windows:
    name: Build & Test ${{ matrix.arch }}-${{ matrix.platform }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: i386
            platform: windows
            runner: windows-2022
            note: "Runs on x64 via WoW64 (32-bit compatibility)"
          - arch: x86_64
            platform: windows
            runner: windows-2022
            note: "Runs natively on x64"
          - arch: aarch64
            platform: windows
            runner: windows-11-arm
            note: "Runs natively on ARM64"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install LLVM and Ninja
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Install Ninja
          choco install ninja -y
          ninja --version

          # Install LLVM
          $ver = "${{ env.LLVM_VERSION }}"
          $exe = "LLVM-$ver-win64.exe"
          $url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-$ver/$exe"

          Write-Host "Downloading LLVM $ver..."
          Invoke-WebRequest -Uri $url -OutFile $exe
          Start-Process -FilePath ".\$exe" -ArgumentList "/S" -Wait

          "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Build -O0
        id: build-o0
        shell: pwsh
        run: |
          cmake -B "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake" -G Ninja -DARCHITECTURE=${{ matrix.arch }} -DPLATFORM=${{ matrix.platform }} -DBUILD_TYPE=release -DOPTIMIZATION_LEVEL=O0
          cmake --build "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake"

      - name: Upload artifacts -O0
        if: steps.build-o0.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}-${{ matrix.platform }}-O0
          retention-days: 1
          path: |
            build/**
            !build/**/cmake/**

      - name: Test EXE -O0
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName

      - name: Test PIC -O0
        shell: pwsh
        run: |
          python scripts/loader.py --arch ${{ matrix.arch }} (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName

      - name: Build -O1
        id: build-o1
        shell: pwsh
        run: |
          cmake -B "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake" -G Ninja -DARCHITECTURE=${{ matrix.arch }} -DPLATFORM=${{ matrix.platform }} -DBUILD_TYPE=release -DOPTIMIZATION_LEVEL=O1
          cmake --build "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake"

      - name: Upload artifacts -O1
        if: steps.build-o1.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}-${{ matrix.platform }}-O1
          retention-days: 1
          path: |
            build/**
            !build/**/cmake/**

      - name: Test EXE -O1
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName

      - name: Test PIC -O1
        shell: pwsh
        run: |
          python scripts/loader.py --arch ${{ matrix.arch }} (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName

      - name: Build -O2
        id: build-o2
        shell: pwsh
        run: |
          cmake -B "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake" -G Ninja -DARCHITECTURE=${{ matrix.arch }} -DPLATFORM=${{ matrix.platform }} -DBUILD_TYPE=release -DOPTIMIZATION_LEVEL=O2
          cmake --build "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake"

      - name: Upload artifacts -O2
        if: steps.build-o2.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}-${{ matrix.platform }}-O2
          retention-days: 1
          path: |
            build/**
            !build/**/cmake/**

      - name: Test EXE -O2
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName

      - name: Test PIC -O2
        shell: pwsh
        run: |
          python scripts/loader.py --arch ${{ matrix.arch }} (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName

      - name: Build -O3
        id: build-o3
        shell: pwsh
        run: |
          cmake -B "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake" -G Ninja -DARCHITECTURE=${{ matrix.arch }} -DPLATFORM=${{ matrix.platform }} -DBUILD_TYPE=release -DOPTIMIZATION_LEVEL=O3
          cmake --build "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake"

      - name: Upload artifacts -O3
        if: steps.build-o3.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}-${{ matrix.platform }}-O3
          retention-days: 1
          path: |
            build/**
            !build/**/cmake/**

      - name: Test EXE -O3
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName

      - name: Test PIC -O3
        shell: pwsh
        run: |
          python scripts/loader.py --arch ${{ matrix.arch }} (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName

      - name: Build -Os
        id: build-os
        shell: pwsh
        run: |
          cmake -B "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake" -G Ninja -DARCHITECTURE=${{ matrix.arch }} -DPLATFORM=${{ matrix.platform }} -DBUILD_TYPE=release -DOPTIMIZATION_LEVEL=Os
          cmake --build "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake"

      - name: Upload artifacts -Os
        if: steps.build-os.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}-${{ matrix.platform }}-Os
          retention-days: 1
          path: |
            build/**
            !build/**/cmake/**

      - name: Test EXE -Os
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName

      - name: Test PIC -Os
        shell: pwsh
        run: |
          python scripts/loader.py --arch ${{ matrix.arch }} (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName

      - name: Build -Oz
        id: build-oz
        shell: pwsh
        run: |
          cmake -B "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake" -G Ninja -DARCHITECTURE=${{ matrix.arch }} -DPLATFORM=${{ matrix.platform }} -DBUILD_TYPE=release -DOPTIMIZATION_LEVEL=Oz
          cmake --build "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake"

      - name: Upload artifacts -Oz
        if: steps.build-oz.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}-${{ matrix.platform }}-Oz
          retention-days: 1
          path: |
            build/**
            !build/**/cmake/**

      - name: Test EXE -Oz
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName

      - name: Test PIC -Oz
        shell: pwsh
        run: |
          python scripts/loader.py --arch ${{ matrix.arch }} (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName

      - name: Build -Og
        id: build-og
        shell: pwsh
        run: |
          cmake -B "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake" -G Ninja -DARCHITECTURE=${{ matrix.arch }} -DPLATFORM=${{ matrix.platform }} -DBUILD_TYPE=release -DOPTIMIZATION_LEVEL=Og
          cmake --build "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake"

      - name: Upload artifacts -Og
        if: steps.build-og.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}-${{ matrix.platform }}-Og
          retention-days: 1
          path: |
            build/**
            !build/**/cmake/**

      - name: Test EXE -Og
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName

      - name: Test PIC -Og
        shell: pwsh
        run: |
          python scripts/loader.py --arch ${{ matrix.arch }} (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName

  build-and-test-linux:
    name: Build & Test ${{ matrix.arch }}-${{ matrix.platform }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: i386
            platform: linux
            qemu: qemu-i386-static
            note: "Runs via QEMU i386"
          - arch: x86_64
            platform: linux
            qemu: ""
            note: "Runs natively on x64"
          - arch: armv7a
            platform: linux
            qemu: qemu-arm-static
            note: "Runs via QEMU ARM"
          - arch: aarch64
            platform: linux
            qemu: qemu-aarch64-static
            note: "Runs via QEMU ARM64"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install LLVM and Ninja
        run: |
          set -e
          # Extract major version for apt (e.g., "20" from "20.1.6")
          LLVM_VER=$(echo "${{ env.LLVM_VERSION }}" | cut -d. -f1)

          # Install dependencies and Ninja
          sudo apt-get update
          sudo apt-get install -y ninja-build wget lsb-release ca-certificates gnupg cmake
          ninja --version

          # Add LLVM apt repository
          sudo mkdir -p /etc/apt/keyrings
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/apt.llvm.org.gpg >/dev/null
          echo "deb [signed-by=/etc/apt/keyrings/apt.llvm.org.gpg] http://apt.llvm.org/$(lsb_release -cs)/ llvm-toolchain-$(lsb_release -cs)-${LLVM_VER} main" | sudo tee /etc/apt/sources.list.d/llvm.list
          sudo apt-get update

          # Install LLVM, Clang, LLD, and tools
          sudo apt-get install -y clang-${LLVM_VER} clang++-${LLVM_VER} lld-${LLVM_VER} llvm-${LLVM_VER}

          # Create symbolic links for all required tools
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-${LLVM_VER} 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-${LLVM_VER} 100
          sudo update-alternatives --install /usr/bin/lld lld /usr/bin/lld-${LLVM_VER} 100
          sudo update-alternatives --install /usr/bin/ld.lld ld.lld /usr/bin/ld.lld-${LLVM_VER} 100
          sudo update-alternatives --install /usr/bin/llvm-objdump llvm-objdump /usr/bin/llvm-objdump-${LLVM_VER} 100
          sudo update-alternatives --install /usr/bin/llvm-objcopy llvm-objcopy /usr/bin/llvm-objcopy-${LLVM_VER} 100
          sudo update-alternatives --install /usr/bin/llvm-strings llvm-strings /usr/bin/llvm-strings-${LLVM_VER} 100

          # Select the installed LLVM version
          sudo update-alternatives --set clang /usr/bin/clang-${LLVM_VER}
          sudo update-alternatives --set clang++ /usr/bin/clang++-${LLVM_VER}
          sudo update-alternatives --set lld /usr/bin/lld-${LLVM_VER}
          sudo update-alternatives --set ld.lld /usr/bin/ld.lld-${LLVM_VER}
          sudo update-alternatives --set llvm-objdump /usr/bin/llvm-objdump-${LLVM_VER}
          sudo update-alternatives --set llvm-objcopy /usr/bin/llvm-objcopy-${LLVM_VER}
          sudo update-alternatives --set llvm-strings /usr/bin/llvm-strings-${LLVM_VER}

          # Verify installation
          clang --version

      - name: Install QEMU
        if: matrix.qemu != ''
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static

      - name: Build -O0
        id: build-o0
        run: |
          cmake -B "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake" -G Ninja -DARCHITECTURE=${{ matrix.arch }} -DPLATFORM=${{ matrix.platform }} -DBUILD_TYPE=release -DOPTIMIZATION_LEVEL=O0
          cmake --build "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake"

      - name: Upload artifacts -O0
        if: steps.build-o0.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}-${{ matrix.platform }}-O0
          retention-days: 1
          path: |
            build/**
            !build/**/cmake/**

      - name: Test ELF -O0
        run: |
          TEST_ELF=$(find build -type f -name "output.elf" | head -n 1)
          chmod +x "$TEST_ELF"
          if [ -n "${{ matrix.qemu }}" ]; then ${{ matrix.qemu }} "$TEST_ELF"; else "$TEST_ELF"; fi

      - name: Test PIC -O0
        run: |
          python3 scripts/loader.py --arch ${{ matrix.arch }} $(find build -type f -name "output.bin" | head -n 1)

      - name: Build -O1
        id: build-o1
        run: |
          cmake -B "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake" -G Ninja -DARCHITECTURE=${{ matrix.arch }} -DPLATFORM=${{ matrix.platform }} -DBUILD_TYPE=release -DOPTIMIZATION_LEVEL=O1
          cmake --build "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake"

      - name: Upload artifacts -O1
        if: steps.build-o1.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}-${{ matrix.platform }}-O1
          retention-days: 1
          path: |
            build/**
            !build/**/cmake/**

      - name: Test ELF -O1
        run: |
          TEST_ELF=$(find build -type f -name "output.elf" | head -n 1)
          chmod +x "$TEST_ELF"
          if [ -n "${{ matrix.qemu }}" ]; then ${{ matrix.qemu }} "$TEST_ELF"; else "$TEST_ELF"; fi

      - name: Test PIC -O1
        run: |
          python3 scripts/loader.py --arch ${{ matrix.arch }} $(find build -type f -name "output.bin" | head -n 1)

      - name: Build -O2
        id: build-o2
        run: |
          cmake -B "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake" -G Ninja -DARCHITECTURE=${{ matrix.arch }} -DPLATFORM=${{ matrix.platform }} -DBUILD_TYPE=release -DOPTIMIZATION_LEVEL=O2
          cmake --build "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake"

      - name: Upload artifacts -O2
        if: steps.build-o2.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}-${{ matrix.platform }}-O2
          retention-days: 1
          path: |
            build/**
            !build/**/cmake/**

      - name: Test ELF -O2
        run: |
          TEST_ELF=$(find build -type f -name "output.elf" | head -n 1)
          chmod +x "$TEST_ELF"
          if [ -n "${{ matrix.qemu }}" ]; then ${{ matrix.qemu }} "$TEST_ELF"; else "$TEST_ELF"; fi

      - name: Test PIC -O2
        run: |
          python3 scripts/loader.py --arch ${{ matrix.arch }} $(find build -type f -name "output.bin" | head -n 1)

      - name: Build -O3
        id: build-o3
        run: |
          cmake -B "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake" -G Ninja -DARCHITECTURE=${{ matrix.arch }} -DPLATFORM=${{ matrix.platform }} -DBUILD_TYPE=release -DOPTIMIZATION_LEVEL=O3
          cmake --build "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake"

      - name: Upload artifacts -O3
        if: steps.build-o3.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}-${{ matrix.platform }}-O3
          retention-days: 1
          path: |
            build/**
            !build/**/cmake/**

      - name: Test ELF -O3
        run: |
          TEST_ELF=$(find build -type f -name "output.elf" | head -n 1)
          chmod +x "$TEST_ELF"
          if [ -n "${{ matrix.qemu }}" ]; then ${{ matrix.qemu }} "$TEST_ELF"; else "$TEST_ELF"; fi

      - name: Test PIC -O3
        run: |
          python3 scripts/loader.py --arch ${{ matrix.arch }} $(find build -type f -name "output.bin" | head -n 1)

      - name: Build -Os
        id: build-os
        run: |
          cmake -B "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake" -G Ninja -DARCHITECTURE=${{ matrix.arch }} -DPLATFORM=${{ matrix.platform }} -DBUILD_TYPE=release -DOPTIMIZATION_LEVEL=Os
          cmake --build "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake"

      - name: Upload artifacts -Os
        if: steps.build-os.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}-${{ matrix.platform }}-Os
          retention-days: 1
          path: |
            build/**
            !build/**/cmake/**

      - name: Test ELF -Os
        run: |
          TEST_ELF=$(find build -type f -name "output.elf" | head -n 1)
          chmod +x "$TEST_ELF"
          if [ -n "${{ matrix.qemu }}" ]; then ${{ matrix.qemu }} "$TEST_ELF"; else "$TEST_ELF"; fi

      - name: Test PIC -Os
        run: |
          python3 scripts/loader.py --arch ${{ matrix.arch }} $(find build -type f -name "output.bin" | head -n 1)

      - name: Build -Oz
        id: build-oz
        run: |
          cmake -B "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake" -G Ninja -DARCHITECTURE=${{ matrix.arch }} -DPLATFORM=${{ matrix.platform }} -DBUILD_TYPE=release -DOPTIMIZATION_LEVEL=Oz
          cmake --build "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake"

      - name: Upload artifacts -Oz
        if: steps.build-oz.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}-${{ matrix.platform }}-Oz
          retention-days: 1
          path: |
            build/**
            !build/**/cmake/**

      - name: Test ELF -Oz
        run: |
          TEST_ELF=$(find build -type f -name "output.elf" | head -n 1)
          chmod +x "$TEST_ELF"
          if [ -n "${{ matrix.qemu }}" ]; then ${{ matrix.qemu }} "$TEST_ELF"; else "$TEST_ELF"; fi

      - name: Test PIC -Oz
        run: |
          python3 scripts/loader.py --arch ${{ matrix.arch }} $(find build -type f -name "output.bin" | head -n 1)

      - name: Build -Og
        id: build-og
        run: |
          cmake -B "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake" -G Ninja -DARCHITECTURE=${{ matrix.arch }} -DPLATFORM=${{ matrix.platform }} -DBUILD_TYPE=release -DOPTIMIZATION_LEVEL=Og
          cmake --build "build/release/${{ matrix.platform }}/${{ matrix.arch }}/cmake"

      - name: Upload artifacts -Og
        if: steps.build-og.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}-${{ matrix.platform }}-Og
          retention-days: 1
          path: |
            build/**
            !build/**/cmake/**

      - name: Test ELF -Og
        run: |
          TEST_ELF=$(find build -type f -name "output.elf" | head -n 1)
          chmod +x "$TEST_ELF"
          if [ -n "${{ matrix.qemu }}" ]; then ${{ matrix.qemu }} "$TEST_ELF"; else "$TEST_ELF"; fi

      - name: Test PIC -Og
        run: |
          python3 scripts/loader.py --arch ${{ matrix.arch }} $(find build -type f -name "output.bin" | head -n 1)