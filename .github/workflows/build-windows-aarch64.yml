name: Windows aarch64

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - "**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  LLVM_VERSION: "21.1.0"

jobs:
  build-and-test:
    name: -${{ matrix.opt }}
    runs-on: windows-11-arm
    strategy:
      fail-fast: false
      matrix:
        opt: [O0, O1, O2, O3, Os, Oz, Og]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache LLVM
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: C:\Program Files\LLVM
          key: llvm-${{ env.LLVM_VERSION }}-windows-11-arm

      - name: Install Ninja
        shell: pwsh
        run: |
          choco install ninja -y
          ninja --version

      - name: Install LLVM
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ver = "${{ env.LLVM_VERSION }}"
          $exe = "LLVM-$ver-win64.exe"
          $url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-$ver/$exe"

          Write-Host "Downloading LLVM $ver..."
          Invoke-WebRequest -Uri $url -OutFile $exe
          Start-Process -FilePath ".\$exe" -ArgumentList "/S" -Wait

      - name: Add LLVM to PATH
        shell: pwsh
        run: |
          "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Build -${{ matrix.opt }}
        shell: pwsh
        run: |
          cmake --preset windows-aarch64-release "-DOPTIMIZATION_LEVEL=${{ matrix.opt }}"
          cmake --build --preset windows-aarch64-release

      - name: Test EXE -${{ matrix.opt }}
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName

      - name: Test PIC -${{ matrix.opt }}
        shell: pwsh
        run: |
          python scripts/loader.py --arch aarch64 (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-windows-aarch64-${{ matrix.opt }}
          retention-days: 1
          path: |
            build/
            !build/**/cmake/
