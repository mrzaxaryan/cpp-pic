name: Size Regression

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: size-${{ github.ref }}
  cancel-in-progress: true

env:
  LLVM_VERSION: "20.1.6"

jobs:
  size-linux:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        arch: [i386, x86_64, armv7a, aarch64]
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: pr

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main

      - name: Install LLVM and Ninja
        run: |
          set -e
          LLVM_VER=$(echo "${{ env.LLVM_VERSION }}" | cut -d. -f1)
          sudo apt-get update
          sudo apt-get install -y ninja-build wget lsb-release ca-certificates gnupg cmake
          sudo mkdir -p /etc/apt/keyrings
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/apt.llvm.org.gpg >/dev/null
          echo "deb [signed-by=/etc/apt/keyrings/apt.llvm.org.gpg] http://apt.llvm.org/$(lsb_release -cs)/ llvm-toolchain-$(lsb_release -cs)-${LLVM_VER} main" | sudo tee /etc/apt/sources.list.d/llvm.list
          sudo apt-get update
          sudo apt-get install -y clang-${LLVM_VER} clang++-${LLVM_VER} lld-${LLVM_VER} llvm-${LLVM_VER}
          for tool in clang clang++ lld ld.lld llvm-objdump llvm-objcopy llvm-strings; do
            sudo update-alternatives --install /usr/bin/$tool $tool /usr/bin/$tool-${LLVM_VER} 100
            sudo update-alternatives --set $tool /usr/bin/$tool-${LLVM_VER}
          done

      - name: Build main branch (Oz)
        working-directory: main
        run: |
          cmake --preset linux-${{ matrix.arch }}-release -DOPTIMIZATION_LEVEL=Oz
          cmake --build --preset linux-${{ matrix.arch }}-release

      - name: Build PR branch (Oz)
        working-directory: pr
        run: |
          cmake --preset linux-${{ matrix.arch }}-release -DOPTIMIZATION_LEVEL=Oz
          cmake --build --preset linux-${{ matrix.arch }}-release

      - name: Get sizes
        id: size
        run: |
          MAIN_BIN=$(find main/build -type f -name "output.bin" | head -n 1)
          PR_BIN=$(find pr/build -type f -name "output.bin" | head -n 1)
          echo "main_bin=$(stat -c%s "$MAIN_BIN" 2>/dev/null || echo 0)" >> $GITHUB_OUTPUT
          echo "pr_bin=$(stat -c%s "$PR_BIN" 2>/dev/null || echo 0)" >> $GITHUB_OUTPUT

      - name: Upload size data
        uses: actions/upload-artifact@v4
        with:
          name: size-linux-${{ matrix.arch }}
          path: |
            main/build/**/output.bin
            pr/build/**/output.bin
          retention-days: 1

      - name: Save size info
        run: |
          echo "linux-${{ matrix.arch }},${{ steps.size.outputs.main_bin }},${{ steps.size.outputs.pr_bin }}" > size-linux-${{ matrix.arch }}.csv

      - name: Upload size CSV
        uses: actions/upload-artifact@v4
        with:
          name: csv-linux-${{ matrix.arch }}
          path: size-linux-${{ matrix.arch }}.csv

  size-windows:
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        arch: [i386, x86_64, aarch64]
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: pr

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main

      - name: Cache LLVM
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: C:\Program Files\LLVM
          key: llvm-${{ env.LLVM_VERSION }}-windows-2022

      - name: Install Ninja
        shell: pwsh
        run: |
          choco install ninja -y

      - name: Install LLVM
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ver = "${{ env.LLVM_VERSION }}"
          $exe = "LLVM-$ver-win64.exe"
          $url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-$ver/$exe"
          Invoke-WebRequest -Uri $url -OutFile $exe
          Start-Process -FilePath ".\$exe" -ArgumentList "/S" -Wait

      - name: Add LLVM to PATH
        shell: pwsh
        run: |
          "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Build main branch (Oz)
        shell: pwsh
        working-directory: main
        run: |
          cmake --preset windows-${{ matrix.arch }}-release "-DOPTIMIZATION_LEVEL=Oz"
          cmake --build --preset windows-${{ matrix.arch }}-release

      - name: Build PR branch (Oz)
        shell: pwsh
        working-directory: pr
        run: |
          cmake --preset windows-${{ matrix.arch }}-release "-DOPTIMIZATION_LEVEL=Oz"
          cmake --build --preset windows-${{ matrix.arch }}-release

      - name: Get sizes
        id: size
        shell: pwsh
        run: |
          $mainBin = Get-ChildItem -Path main/build -Recurse -Filter "output.bin" | Select-Object -First 1
          $prBin = Get-ChildItem -Path pr/build -Recurse -Filter "output.bin" | Select-Object -First 1
          $mainSize = if ($mainBin) { $mainBin.Length } else { 0 }
          $prSize = if ($prBin) { $prBin.Length } else { 0 }
          "main_bin=$mainSize" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "pr_bin=$prSize" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Save size info
        shell: pwsh
        run: |
          "windows-${{ matrix.arch }},${{ steps.size.outputs.main_bin }},${{ steps.size.outputs.pr_bin }}" | Out-File -FilePath "size-windows-${{ matrix.arch }}.csv" -NoNewline

      - name: Upload size CSV
        uses: actions/upload-artifact@v4
        with:
          name: csv-windows-${{ matrix.arch }}
          path: size-windows-${{ matrix.arch }}.csv

  size-uefi:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, aarch64]
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: pr

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main

      - name: Install LLVM and Ninja
        run: |
          set -e
          LLVM_VER=$(echo "${{ env.LLVM_VERSION }}" | cut -d. -f1)
          sudo apt-get update
          sudo apt-get install -y ninja-build wget lsb-release ca-certificates gnupg cmake
          sudo mkdir -p /etc/apt/keyrings
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/apt.llvm.org.gpg >/dev/null
          echo "deb [signed-by=/etc/apt/keyrings/apt.llvm.org.gpg] http://apt.llvm.org/$(lsb_release -cs)/ llvm-toolchain-$(lsb_release -cs)-${LLVM_VER} main" | sudo tee /etc/apt/sources.list.d/llvm.list
          sudo apt-get update
          sudo apt-get install -y clang-${LLVM_VER} clang++-${LLVM_VER} lld-${LLVM_VER} llvm-${LLVM_VER}
          for tool in clang clang++ lld ld.lld llvm-objdump llvm-objcopy llvm-strings; do
            sudo update-alternatives --install /usr/bin/$tool $tool /usr/bin/$tool-${LLVM_VER} 100
            sudo update-alternatives --set $tool /usr/bin/$tool-${LLVM_VER}
          done

      - name: Build main branch (Oz)
        working-directory: main
        run: |
          cmake --preset uefi-${{ matrix.arch }}-release -DOPTIMIZATION_LEVEL=Oz
          cmake --build --preset uefi-${{ matrix.arch }}-release

      - name: Build PR branch (Oz)
        working-directory: pr
        run: |
          cmake --preset uefi-${{ matrix.arch }}-release -DOPTIMIZATION_LEVEL=Oz
          cmake --build --preset uefi-${{ matrix.arch }}-release

      - name: Get sizes
        id: size
        run: |
          MAIN_EFI=$(find main/build -type f -name "*.efi" | head -n 1)
          PR_EFI=$(find pr/build -type f -name "*.efi" | head -n 1)
          echo "main_bin=$(stat -c%s "$MAIN_EFI" 2>/dev/null || echo 0)" >> $GITHUB_OUTPUT
          echo "pr_bin=$(stat -c%s "$PR_EFI" 2>/dev/null || echo 0)" >> $GITHUB_OUTPUT

      - name: Save size info
        run: |
          echo "uefi-${{ matrix.arch }},${{ steps.size.outputs.main_bin }},${{ steps.size.outputs.pr_bin }}" > size-uefi-${{ matrix.arch }}.csv

      - name: Upload size CSV
        uses: actions/upload-artifact@v4
        with:
          name: csv-uefi-${{ matrix.arch }}
          path: size-uefi-${{ matrix.arch }}.csv

  report:
    needs: [size-linux, size-windows, size-uefi]
    runs-on: ubuntu-22.04
    permissions:
      pull-requests: write
    steps:
      - name: Download all CSV artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: csv-*
          merge-multiple: true

      - name: Generate report
        id: report
        run: |
          cat << 'SCRIPT' > generate_report.py
          import os
          import glob

          def format_size(size):
              if size >= 1048576:
                  return f"{size / 1048576:.2f} MB"
              elif size >= 1024:
                  return f"{size / 1024:.2f} KB"
              return f"{size} B"

          def format_diff(diff):
              return f"+{diff}" if diff > 0 else str(diff)

          def get_status(diff):
              if diff < 0:
                  return "ðŸ“‰"
              elif diff > 0:
                  return "ðŸ“ˆ"
              return "âž¡ï¸"

          rows = []
          for csv_file in sorted(glob.glob("*.csv")):
              with open(csv_file) as f:
                  line = f.read().strip()
                  if line:
                      parts = line.split(",")
                      if len(parts) == 3:
                          target, main_size, pr_size = parts
                          main_size = int(main_size)
                          pr_size = int(pr_size)
                          diff = pr_size - main_size
                          pct = (diff / main_size * 100) if main_size > 0 else 0
                          rows.append((target, main_size, pr_size, diff, pct))

          # Group by platform
          platforms = {"linux": [], "windows": [], "uefi": []}
          for row in rows:
              target = row[0]
              for p in platforms:
                  if target.startswith(p):
                      platforms[p].append(row)
                      break

          report = "## ðŸ“Š Size Regression Report (-Oz)\n\n"

          for platform, platform_rows in platforms.items():
              if not platform_rows:
                  continue
              report += f"### {platform.capitalize()}\n\n"
              report += "| Architecture | main | PR | Diff | % |\n"
              report += "|--------------|------|-----|------|---|\n"
              for target, main_size, pr_size, diff, pct in platform_rows:
                  arch = target.split("-")[1]
                  status = get_status(diff)
                  report += f"| {arch} | {format_size(main_size)} | {format_size(pr_size)} | {status} {format_diff(diff)} B | {pct:+.2f}% |\n"
              report += "\n"

          # Summary
          total_main = sum(r[1] for r in rows)
          total_pr = sum(r[2] for r in rows)
          total_diff = total_pr - total_main
          total_pct = (total_diff / total_main * 100) if total_main > 0 else 0

          report += f"**Total:** {format_size(total_main)} â†’ {format_size(total_pr)} ({get_status(total_diff)} {format_diff(total_diff)} B, {total_pct:+.2f}%)\n"

          with open("report.md", "w") as f:
              f.write(report)

          print(report)
          SCRIPT

          python3 generate_report.py

          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat report.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: Size Regression Report

      - name: Post or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.report.outputs.report }}
          edit-mode: replace
